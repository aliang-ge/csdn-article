> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/m0_74736832/article/details/136589365)

USB 流量包分析
---------

USB 流量主要分为两种，一种是鼠标流量，另一种是键盘流量。

### 键盘流量

[流量分析](https://so.csdn.net/so/search?q=%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90&spm=1001.2101.3001.7020)的话我们这里直接使用 kali linux 中的 tshark 命令把 cap data 提取出来：

```
tshark -r usb.pcap -T fields -e usb.capdata | sed '/^\s*$/d' > usbdata.txt #提取并去除空行
```

中间那个是[正则匹配](https://so.csdn.net/so/search?q=%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D&spm=1001.2101.3001.7020)，去除空行。

提取出来的数据可能会带冒号，也可能不带（有可能和 wireshark 的版本相关），但是一般的脚本都会按照有冒号的数据来识别

> 有冒号时提取数据的`[6:8]`  
> 无冒号时数据在`[4:6]`  
> ![](https://img-blog.csdnimg.cn/direct/c3e8b67b379f4f62ac161e0ac28957d6.png)

我的这个案例提取出来是无冒号的；

这里的话我们还需要知道键盘输入的键盘按键值对应的编码表

```
normalKeys = {"04":"a", "05":"b", "06":"c", "07":"d", "08":"e", "09":"f", "0a":"g", "0b":"h", "0c":"i", "0d":"j", "0e":"k", "0f":"l", "10":"m", "11":"n", "12":"o", "13":"p", "14":"q", "15":"r", "16":"s", "17":"t", "18":"u", "19":"v", "1a":"w", "1b":"x", "1c":"y", "1d":"z","1e":"1", "1f":"2", "20":"3", "21":"4", "22":"5", "23":"6","24":"7","25":"8","26":"9","27":"0","28":"<RET>","29":"<ESC>","2a":"<DEL>", "2b":"\t","2c":"<SPACE>","2d":"-","2e":"=","2f":"[","30":"]","31":"\\","32":"<NON>","33":";","34":"'","35":"<GA>","36":",","37":".","38":"/","39":"<CAP>","3a":"<F1>","3b":"<F2>", "3c":"<F3>","3d":"<F4>","3e":"<F5>","3f":"<F6>","40":"<F7>","41":"<F8>","42":"<F9>","43":"<F10>","44":"<F11>","45":"<F12>"}
shiftKeys = {"04":"A", "05":"B", "06":"C", "07":"D", "08":"E", "09":"F", "0a":"G", "0b":"H", "0c":"I", "0d":"J", "0e":"K", "0f":"L", "10":"M", "11":"N", "12":"O", "13":"P", "14":"Q", "15":"R", "16":"S", "17":"T", "18":"U", "19":"V", "1a":"W", "1b":"X", "1c":"Y", "1d":"Z","1e":"!", "1f":"@", "20":"#", "21":"$", "22":"%", "23":"^","24":"&","25":"*","26":"(","27":")","28":"<RET>","29":"<ESC>","2a":"<DEL>", "2b":"\t","2c":"<SPACE>","2d":"_","2e":"+","2f":"{","30":"}","31":"|","32":"<NON>","33":"\"","34":":","35":"<GA>","36":"<","37":">","38":"?","39":"<CAP>","3a":"<F1>","3b":"<F2>", "3c":"<F3>","3d":"<F4>","3e":"<F5>","3f":"<F6>","40":"<F7>","41":"<F8>","42":"<F9>","43":"<F10>","44":"<F11>","45":"<F12>"}
```

这里 normalKeys 是没有按 shift 键，shiftKeys 是有按 shift 键的。

提取出来的数据前四位是 0b10 就是说明有 shift 键有被 press。这里可以用 & 进行判断，下面的流量包数据由于没有按 shift 键，所以我没有加上这个条件。

我这里就直接把他列出来，接下来我们需要对上面的提取出来的数据进行匹配。

下面我写了一个简单的匹配脚本，进行匹配输出。

```
normalKeys = {"04":"a", "05":"b", "06":"c", "07":"d", "08":"e", "09":"f", "0a":"g", "0b":"h", "0c":"i", "0d":"j", "0e":"k", "0f":"l", "10":"m", "11":"n", "12":"o", "13":"p", "14":"q", "15":"r", "16":"s", "17":"t", "18":"u", "19":"v", "1a":"w", "1b":"x", "1c":"y", "1d":"z","1e":"1", "1f":"2", "20":"3", "21":"4", "22":"5", "23":"6","24":"7","25":"8","26":"9","27":"0","28":"<RET>","29":"<ESC>","2a":"<DEL>", "2b":"\t","2c":"<SPACE>","2d":"-","2e":"=","2f":"[","30":"]","31":"\\","32":"<NON>","33":";","34":"'","35":"<GA>","36":",","37":".","38":"/","39":"<CAP>","3a":"<F1>","3b":"<F2>", "3c":"<F3>","3d":"<F4>","3e":"<F5>","3f":"<F6>","40":"<F7>","41":"<F8>","42":"<F9>","43":"<F10>","44":"<F11>","45":"<F12>"}

fp = open("usbdata.txt",mode='r')
for line in fp:
    if len(line) >=6:
        character = line[4]+line[5]
        if character == '00':
            continue
        print(normalKeys[character],end="")
```

主要的是网上的太麻烦了，看不太懂，就想着写一个简单点的步骤来实现 usb 中键盘数据的翻译。

这里我提取出来的结果是：

> ujkonjk,tfvbhyhjipokrdcvgrdcvgpokqwsztfvbhujkowazxdqasewsdrpokxdfviklpnjkwsdrrfgyrdcvguhnmkbhjmyhji

我发现这个是一个键盘密码；

ujko:i

njk,:m

依次类推最终的结果是：im gulf flag is welcome t fjnu

这里是我做的一道流量题，他的提示是 flag 是残缺的，所以这里我们需要把它补全，flag{welcome_to_fjnu}

ok，收工打酱油。鼠标流量包的话下次有机会做到在补全。  
，所以这里我们需要把它补全，flag{welcome_to_fjnu}

ok，收工打酱油。鼠标流量包的话下次有机会做到在补全。